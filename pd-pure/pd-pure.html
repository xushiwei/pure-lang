<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>pd-pure: Pd loader for Pure scripts</title>
<meta name="author" content="Albert Graef" />
<meta name="copyright" content="Copyright (c) 2009 by Albert Graef. Distributed under the GNU Public License V3, see COPYING for details." />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5631 2008-08-24 13:01:23Z goodger $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="pd-pure-pd-loader-for-pure-scripts">
<h1 class="title">pd-pure: Pd loader for Pure scripts</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Albert Graef</td></tr>
<tr><th class="docinfo-name">Contact:</th>
<td><a class="first last reference external" href="mailto:Dr.Graef&#64;t-online.de">Dr.Graef&#64;t-online.de</a></td></tr>
<tr><th class="docinfo-name">Copyright:</th>
<td>Copyright (c) 2009 by Albert Graef. Distributed under the GNU
Public License V3, see COPYING for details.</td></tr>
</tbody>
</table>
<p>This plugin lets you write external <a class="reference external" href="http://puredata.info/">Pd</a> control objects in Pure. <a class="reference external" href="http://pure-lang.googlecode.com/">Pure</a> is a
functional programming language based on the term rewriting calculus.</p>
<p>This is still an experimental version, please report bugs to the author. In
particular, note that the embedded Pure interpreter uses the same kind of JIT
compiler as the command line version, which may cause annoying delays during
startup, since the Pure functions are compiled by the JIT when they are first
used. (However, once all Pure objects have been compiled to native code, they
are executed very efficiently.) With the current version of the LLVM JIT used
by the Pure interpreter there's no easy way around this, but we hope to fix
this issue in a future release.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#installation" id="id1">1&nbsp;&nbsp;&nbsp;Installation</a><ul class="auto-toc">
<li><a class="reference internal" href="#pd-pure-on-windows" id="id2">1.1&nbsp;&nbsp;&nbsp;pd-pure on Windows</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage" id="id3">2&nbsp;&nbsp;&nbsp;Usage</a><ul class="auto-toc">
<li><a class="reference internal" href="#simple-objects" id="id4">2.1&nbsp;&nbsp;&nbsp;Simple Objects</a></li>
<li><a class="reference internal" href="#creation-arguments" id="id5">2.2&nbsp;&nbsp;&nbsp;Creation Arguments</a></li>
<li><a class="reference internal" href="#the-pure-object" id="id6">2.3&nbsp;&nbsp;&nbsp;The [pure] Object</a></li>
<li><a class="reference internal" href="#configuring-inlets-and-outlets" id="id7">2.4&nbsp;&nbsp;&nbsp;Configuring Inlets and Outlets</a></li>
<li><a class="reference internal" href="#local-state" id="id8">2.5&nbsp;&nbsp;&nbsp;Local State</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-features" id="id9">3&nbsp;&nbsp;&nbsp;Advanced Features</a><ul class="auto-toc">
<li><a class="reference internal" href="#asynchronous-messages" id="id10">3.1&nbsp;&nbsp;&nbsp;Asynchronous Messages</a></li>
<li><a class="reference internal" href="#reading-and-writing-audio-data" id="id11">3.2&nbsp;&nbsp;&nbsp;Reading and Writing Audio Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#programming-interface" id="id12">4&nbsp;&nbsp;&nbsp;Programming Interface</a></li>
<li><a class="reference internal" href="#interactive-facilities" id="id13">5&nbsp;&nbsp;&nbsp;Interactive Facilities</a><ul class="auto-toc">
<li><a class="reference internal" href="#livecoding-support" id="id14">5.1&nbsp;&nbsp;&nbsp;Livecoding Support</a></li>
<li><a class="reference internal" href="#remote-control" id="id15">5.2&nbsp;&nbsp;&nbsp;Remote Control</a></li>
</ul>
</li>
</ul>
</div>
<!-- Note: If you're wondering about the funny formatting, this README
simultaneously serves to generate the documentation for this module
in a variety of formats, using the docutils text formatting system
(http://docutils.sourceforge.net/). -->
<div class="section" id="installation">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Installation</a></h1>
<p>MS Windows users please see <a class="reference internal" href="#pd-pure-on-windows">pd-pure on Windows</a> below.</p>
<p>Usually, <tt class="docutils literal"><span class="pre">make</span> <span class="pre">&amp;&amp;</span> <span class="pre">sudo</span> <span class="pre">make</span> <span class="pre">install</span></tt> should do the trick. This will compile
the external (you need to have GNU make, Pd and Pure installed to do that) and
install it in the lib/pd/extra/pure directory.</p>
<p>The Makefile tries to guess the installation prefix under which Pd is
installed. If it guesses wrong, you can tell it the right prefix with <tt class="docutils literal"><span class="pre">make</span>
<span class="pre">prefix=/some/path</span></tt>. Or you can specify the exact path of the lib/pd directory
with <tt class="docutils literal"><span class="pre">make</span> <span class="pre">pdlibdir=/some/path</span></tt>; by default the Makefile assumes
<tt class="docutils literal"><span class="pre">$(prefix)/lib/pd</span></tt>.</p>
<p>The Makefile also tries to guess the host system type and set up some
platform-specific things accordingly. If this doesn't work for your system
then you'll have to edit the Makefile accordingly.</p>
<p>After installation, you still have to tell Pd to load the Pure external at
startup, either with the <tt class="docutils literal"><span class="pre">-lib</span></tt> option (<tt class="docutils literal"><span class="pre">pd</span> <span class="pre">-lib</span> <span class="pre">pure</span></tt>), or by specifying
<tt class="docutils literal"><span class="pre">pure</span></tt> in the File/Startup options. (This setting can be saved so that the
Pure loader is always available when you run Pd.)</p>
<div class="section" id="pd-pure-on-windows">
<h2><a class="toc-backref" href="#id2">1.1&nbsp;&nbsp;&nbsp;pd-pure on Windows</a></h2>
<p>There's a binary package in MSI format available at the Pure website. In
addition, you'll need the Pure interpreter, and a version of Pd which has been
compiled with <a class="reference external" href="http://mingw.org">mingw</a>; for your convenience, we provide a package for that as
well. You can find all packages on the Download page at
<a class="reference external" href="http://pure-lang.googlecode.com">http://pure-lang.googlecode.com</a>. For instance, at the time of this writing,
the available packages are:</p>
<ul class="simple">
<li><a class="reference external" href="http://pure-lang.googlecode.com/files/pure-0.28.msi">http://pure-lang.googlecode.com/files/pure-0.28.msi</a></li>
<li><a class="reference external" href="http://pure-lang.googlecode.com/files/pd-mingw-0.42-5.msi">http://pure-lang.googlecode.com/files/pd-mingw-0.42-5.msi</a></li>
<li><a class="reference external" href="http://pure-lang.googlecode.com/files/pd-pure-0.6.msi">http://pure-lang.googlecode.com/files/pd-pure-0.6.msi</a></li>
</ul>
<p>Make sure that you get the latest versions of these packages. After installing
the packages, you still have to configure Pd to load the <tt class="docutils literal"><span class="pre">pure</span></tt> external at
startup (see above).</p>
<p>Please note that our binary pd-pure package does <em>not</em> work with the official
Windows binaries of Pd available at <a class="reference external" href="http://crca.ucsd.edu/~msp/software.html">http://crca.ucsd.edu/~msp/software.html</a>.
Apparently, some mingw-compiled plugins fail to load in a Pd version compiled
with MSVC because of version mismatches in required libraries. Unfortunately,
pd-pure is one of those (pthreadGC2.dll seems to be the main culprit here). So
you'll have to use the mingw-compiled Pd version we provide, or roll your own.</p>
</div>
</div>
<div class="section" id="usage">
<h1><a class="toc-backref" href="#id3">2&nbsp;&nbsp;&nbsp;Usage</a></h1>
<p>See the pure-help.pd patch for a few examples. Basically, to implement a Pd
object named <tt class="docutils literal"><span class="pre">foo</span></tt>, you have to supply a Pure script named foo.pure which
defines a function <tt class="docutils literal"><span class="pre">foo</span></tt> and anything else that it might need. Put that
script in the same directory as the Pd patch in which you want to use the
<tt class="docutils literal"><span class="pre">foo</span></tt> object (or anywhere on Pd's search path). The <tt class="docutils literal"><span class="pre">foo</span></tt> function gets
evaluated at object creation time, receiving any additional parameters the
object is created with. The resulting Pure expression (which can also just be
<tt class="docutils literal"><span class="pre">foo</span></tt> itself) becomes the object executed at runtime, by passing Pd messages
from the inlets as parameters, and routing the function results to the outlets
of the object.</p>
<p>Pd messages are translated to corresponding Pure expressions and vice versa in
a straightforward fashion. Special support is provided for converting between
the natural Pd and Pure representations of floating point numbers, symbols and
lists. The following table summarizes the available conversions.</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="33%" />
<col width="39%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Message Type</th>
<th class="head">Pd</th>
<th class="head">Pure</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>symbol</td>
<td><tt class="docutils literal"><span class="pre">foo</span></tt></td>
<td><tt class="docutils literal"><span class="pre">foo</span></tt></td>
</tr>
<tr><td>string</td>
<td><tt class="docutils literal"><span class="pre">a&amp;b</span></tt></td>
<td><tt class="docutils literal"><span class="pre">&quot;a&amp;b&quot;</span></tt></td>
</tr>
<tr><td>float</td>
<td><tt class="docutils literal"><span class="pre">float</span> <span class="pre">1.23</span></tt></td>
<td><tt class="docutils literal"><span class="pre">1.23</span></tt></td>
</tr>
<tr><td>list</td>
<td><tt class="docutils literal"><span class="pre">list</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">3</span></tt></td>
<td><tt class="docutils literal"><span class="pre">[1.0,2.0,3.0]</span></tt></td>
</tr>
<tr><td>other</td>
<td><tt class="docutils literal"><span class="pre">foo</span> <span class="pre">a</span> <span class="pre">2</span> <span class="pre">3</span></tt></td>
<td><tt class="docutils literal"><span class="pre">foo</span> <span class="pre">a</span> <span class="pre">2.0</span> <span class="pre">3.0</span></tt></td>
</tr>
</tbody>
</table>
<p>Note that Pd symbols which are no valid Pure symbols become strings in
Pure. Conversely, both symbols and strings in Pure are mapped to corresponding
Pd symbols. Pure (machine) integers and floating point values both become
<tt class="docutils literal"><span class="pre">float</span></tt> messages in Pd. Pd list messages are translated to Pure list values,
while other aggregate messages are mapped to Pure applications (and vice
versa).</p>
<div class="section" id="simple-objects">
<h2><a class="toc-backref" href="#id4">2.1&nbsp;&nbsp;&nbsp;Simple Objects</a></h2>
<p>By default, a Pure object has just one inlet and one outlet and thus acts like
a simple function with no internal state. For instance, the following object
accepts Pd <tt class="docutils literal"><span class="pre">float</span></tt> messages and adds 5 to each received value:</p>
<pre class="literal-block">
add5 x = x+5;
</pre>
<p>In the Pd patch each <tt class="docutils literal"><span class="pre">[add5]</span></tt> object then has a single inlet supplying
parameters and a single outlet for results of the add5 function.</p>
</div>
<div class="section" id="creation-arguments">
<h2><a class="toc-backref" href="#id5">2.2&nbsp;&nbsp;&nbsp;Creation Arguments</a></h2>
<p>You can parameterize an object with creation arguments, which are passed to
the Pure function at object creation time. For instance:</p>
<pre class="literal-block">
add x y = x+y;
</pre>
<p>This object can then be invoked, e.g., as <tt class="docutils literal"><span class="pre">[add</span> <span class="pre">5]</span></tt> in the Pd patch to
supply the needed creation argument x.</p>
</div>
<div class="section" id="the-pure-object">
<h2><a class="toc-backref" href="#id6">2.3&nbsp;&nbsp;&nbsp;The [pure] Object</a></h2>
<p>For simple kinds of objects like these, the Pure loader also provides the
generic <tt class="docutils literal"><span class="pre">[pure]</span></tt> object as a quick means to create Pure objects without
actually preparing a script file. The creation parameter of <tt class="docutils literal"><span class="pre">[pure]</span></tt> is the
object function. This can be a predefined Pure function, or you can define it
on the fly in a <tt class="docutils literal"><span class="pre">with</span></tt> clause.</p>
<p>For instance, <tt class="docutils literal"><span class="pre">[pure</span> <span class="pre">succ]</span></tt> uses the predefined Pure function <tt class="docutils literal"><span class="pre">succ</span></tt> which
adds 1 to its input, while the object <tt class="docutils literal"><span class="pre">[pure</span> <span class="pre">add</span> <span class="pre">5</span> <span class="pre">with</span> <span class="pre">add</span> <span class="pre">x</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">x+y</span> <span class="pre">end]</span></tt>
produces the same results as the <tt class="docutils literal"><span class="pre">[add</span> <span class="pre">5]</span></tt> object defined using a separate
add.pure script in the previous section. You can also generate constant values
that way. E.g., the object <tt class="docutils literal"><span class="pre">[pure</span> <span class="pre">cst</span> <span class="pre">1.618]</span></tt> responds to any message (such
as <tt class="docutils literal"><span class="pre">bang</span></tt>) by producing the constant value 1.618, while the object <tt class="docutils literal"><span class="pre">[pure</span>
<span class="pre">cst</span> <span class="pre">[1..10]]</span></tt> yields the constant list containing the numbers 1..10.</p>
</div>
<div class="section" id="configuring-inlets-and-outlets">
<h2><a class="toc-backref" href="#id7">2.4&nbsp;&nbsp;&nbsp;Configuring Inlets and Outlets</a></h2>
<p>To create an object with multiple inlets and outlets, the object creation
function must return the desired numbers of inlets and outlets, along with a
second function to be applied at runtime, as a tuple <tt class="docutils literal"><span class="pre">n,m,foo</span></tt>. The input
arguments to the runtime function as well as the corresponding function
results are then encoded as pairs <tt class="docutils literal"><span class="pre">k,val</span></tt> where <tt class="docutils literal"><span class="pre">k</span></tt> denotes the inlet or
outlet index. (Note that the <tt class="docutils literal"><span class="pre">k</span></tt> index is provided only if there actually is
more than one inlet. Also, the outlet index is assumed to be zero if none is
specified, so that it can be omitted if there's only one outlet.)</p>
<p>For instance, the following object, invoked as <tt class="docutils literal"><span class="pre">[cross]</span></tt> in the Pd patch,
has two inlets and two outlets and routes messages from the left inlet to the
right outlet and vice versa:</p>
<pre class="literal-block">
cross = 2,2,cross with cross (k,x) = (1-k,x) end;
</pre>
<p>You can also emit multiple messages, possibly to different outlets, in one
go. These must be encoded as lists of values or <tt class="docutils literal"><span class="pre">index,value</span></tt> pairs, which
are emitted in the order in which they are written. E.g., the following
<tt class="docutils literal"><span class="pre">[fan]</span></tt> object implements an &quot;n-fan&quot; which routes its input to <tt class="docutils literal"><span class="pre">n</span></tt> outlets
simultaneously:</p>
<pre class="literal-block">
fan n = 1,n,fan n with fan n x = reverse [k,x | k = 0..n-1] end;
</pre>
<p>(Note that, because of the use of the <tt class="docutils literal"><span class="pre">reverse</span></tt>, the <tt class="docutils literal"><span class="pre">n</span></tt> outlets are
served in right-to-left order here. This is not strictly necessary, but
matches the Pd convention.)</p>
<p>Another example is the following <tt class="docutils literal"><span class="pre">[dup]</span></tt> object with a single inlet and
outlet, which just sends out each received message twice:</p>
<pre class="literal-block">
dup x = [x,x];
</pre>
<p>Note that if you want to output a <em>real</em> list value to an outlet, you'll
either have to specify the outlet index explicitly, or enclose the list in an
extra pair of brackets, since otherwise the list elements will be sent as
separate messages instead (like in the <tt class="docutils literal"><span class="pre">dup</span></tt> example). Thus, to output the
list <tt class="docutils literal"><span class="pre">[x,x]</span></tt> literally, rather than sending <tt class="docutils literal"><span class="pre">x</span></tt> twice, use the following
code:</p>
<pre class="literal-block">
dup2 x = [[x,x]]; // or: 0,[x,x]
</pre>
<p>An object can also just &quot;swallow&quot; messages and generate no output at all. To
these ends, make the object return either an empty list <tt class="docutils literal"><span class="pre">[]</span></tt> or the empty
tuple <tt class="docutils literal"><span class="pre">()</span></tt>. For instance, the following object <tt class="docutils literal"><span class="pre">[echo]</span></tt> implements a sink
which just prints received messages on standard output, which is useful for
debugging purposes:</p>
<pre class="literal-block">
using system;
echo x = () when puts (str x) end;
</pre>
<p>You could also implement this object as follows, by just removing the
superflous outlet (in this case all return values from the function will be
ignored anyway):</p>
<pre class="literal-block">
using system;
echo = 1,0,puts.str;
</pre>
</div>
<div class="section" id="local-state">
<h2><a class="toc-backref" href="#id8">2.5&nbsp;&nbsp;&nbsp;Local State</a></h2>
<p>Local state can be kept in Pure reference values. For instance, the following
<tt class="docutils literal"><span class="pre">[counter]</span></tt> object produces the next counter value when receiving a <tt class="docutils literal"><span class="pre">bang</span></tt>
message:</p>
<pre class="literal-block">
nullary bang;
counter = next (ref 0) with
  next r bang = put r (get r+1);
  next _ _    = () otherwise;
end;
</pre>
</div>
</div>
<div class="section" id="advanced-features">
<h1><a class="toc-backref" href="#id9">3&nbsp;&nbsp;&nbsp;Advanced Features</a></h1>
<div class="section" id="asynchronous-messages">
<h2><a class="toc-backref" href="#id10">3.1&nbsp;&nbsp;&nbsp;Asynchronous Messages</a></h2>
<p>pd-pure provides a simple asynchronous messaging facility which allows a Pure
object to schedule a message to be delivered to itself later. This is useful
for implementing all kinds of delays and, more generally, any kind of object
which, once triggered, does its own sequencing of output messages.</p>
<p>To these ends, the object function may return a special message of the form
<tt class="docutils literal"><span class="pre">pd_delay</span> <span class="pre">t</span> <span class="pre">msg</span></tt> (either by itself or as an element of a result list) to
indicate that the message <tt class="docutils literal"><span class="pre">msg</span></tt> should be delivered to the object function
after <tt class="docutils literal"><span class="pre">t</span></tt> milliseconds (where <tt class="docutils literal"><span class="pre">t</span></tt> is either a machine int or a double
value). After the prescribed delay the object function will then be invoked on
the given message, and the results of this call are processed as usual
(routing messages to outlets and/or scheduling new timer events in response to
further <tt class="docutils literal"><span class="pre">pd_delay</span></tt> messages). Note that if the delay is zero or negative,
the message is scheduled to be delivered immediately.</p>
<p>For instance, a simple kind of delay object can be implemented in Pure as
follows:</p>
<pre class="literal-block">
mydelay _ (alarm msg) = msg;
mydelay t msg = pd_delay t (alarm msg) otherwise;
</pre>
<p>The desired delay time is specified as a creation argument. The first equation
handles messages of the form <tt class="docutils literal"><span class="pre">alarm</span> <span class="pre">msg</span></tt>; the action is to just output the
delayed message given by the <tt class="docutils literal"><span class="pre">msg</span></tt> argument. All other input messages are
scheduled by the second equation, which wraps the message in an <tt class="docutils literal"><span class="pre">alarm</span></tt> term
so that it gets processed by the first equation when it is delivered.</p>
<p>Note that pd-pure only allows you to schedule a single asynchronous event per
call of the object function. Thus, if the <tt class="docutils literal"><span class="pre">mydelay</span></tt> object above receives
another message while it is still waiting for the previous one to be
delivered, the old timer is cancelled and the new one is scheduled instead;
this works like Pd's builtin <tt class="docutils literal"><span class="pre">delay</span></tt> object.</p>
<p>Moreover, scheduling a new event at an infinite (or <tt class="docutils literal"><span class="pre">nan</span></tt>) time value
cancels any existing timer. (Note that you still have to specify the <tt class="docutils literal"><span class="pre">msg</span></tt>
parameter, but it will be ignored in this case.) We can use this to equip our
<tt class="docutils literal"><span class="pre">mydelay</span></tt> object with a <tt class="docutils literal"><span class="pre">stop</span></tt> message as follows:</p>
<pre class="literal-block">
nullary stop;
mydelay _ (alarm msg) = msg;
mydelay _ stop = pd_delay inf ();
mydelay t msg = pd_delay t (alarm msg) otherwise;
</pre>
<p>More elaborate functionality can be built on top of the basic timer facility.
The following example shows how to maintain a timed message queue in a Pure
list, in order to implement a simple delay line similar to Pd's builtin
<tt class="docutils literal"><span class="pre">pipe</span></tt> object. Here we also employ the <tt class="docutils literal"><span class="pre">pd_time</span></tt> function, which is
provided by the Pure loader so that Pure scripts can access the current
logical Pd time in milliseconds (see <a class="reference internal" href="#programming-interface">Programming Interface</a> below). This is
convenient if we need to deal with absolute time values, which we use in this
example to keep track of the times at which messages in the queue are to be
delivered:</p>
<pre class="literal-block">
extern double pd_time();
mypipe t = process (ref []) with
  process q () = case dequeue q of
                   x,(t,_):_ = [x,pd_delay (t-pd_time) ()];
                   x,_ = x;
                 end;
  process q x  = enqueue q x $$ pd_delay t () if null (get q);
               = enqueue q x $$ () otherwise;
  enqueue q x  = put q $ get q+[(pd_time+t,x)];
  dequeue q    = x,put q xs when (_,x):xs = get q end;
end;
</pre>
</div>
<div class="section" id="reading-and-writing-audio-data">
<h2><a class="toc-backref" href="#id11">3.2&nbsp;&nbsp;&nbsp;Reading and Writing Audio Data</a></h2>
<p>At present, pd-pure doesn't support audio objects. However, it is possible to
transfer audio data between Pd and Pure by means of the <tt class="docutils literal"><span class="pre">pd_getbuffer</span></tt> and
<tt class="docutils literal"><span class="pre">pd_setbuffer</span></tt> routines. In Pure land, the audio data is represented as a
vector of floating point values. Please see <a class="reference internal" href="#programming-interface">Programming Interface</a> below for
a closer description of the provided routines.</p>
<p>For instance, here is a <tt class="docutils literal"><span class="pre">randomwave</span></tt> object which fills a Pd array (whose
name is given as the creation argument) with random values in response to a
<tt class="docutils literal"><span class="pre">bang</span></tt> message:</p>
<pre class="literal-block">
extern int pure_random() = random;
randf = random/0x7fffffff;

extern int pd_getbuffersize(char *name);
extern void pd_setbuffer(char *name, expr* x);

nullary bang;

randomwave name = 1,0,process with
  process bang  = pd_setbuffer name {randf | i = 1..nsamples};
  nsamples      = pd_getbuffersize name;
end;
</pre>
</div>
</div>
<div class="section" id="programming-interface">
<h1><a class="toc-backref" href="#id12">4&nbsp;&nbsp;&nbsp;Programming Interface</a></h1>
<p>The Pure loader also provides a number of interface routines which can be
called by Pure scripts running in the Pd environment.</p>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">char</span> <span class="pre">*pd_version_s();</span></tt></p>
<blockquote>
<p>Returns the Pd version number as a string. Note that this routine will only
be available when a script is running inside Pd, so you can quickly check if
that's the case as follows:</p>
<pre class="literal-block">
let ok = stringp $ eval &quot;extern char *pd_version_s(); pd_version_s;&quot;;
</pre>
<p>The <tt class="docutils literal"><span class="pre">ok</span></tt> variable will then be true iff the script is running inside Pd.</p>
</blockquote>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">char</span> <span class="pre">*pd_libdir_s();</span></tt></p>
<blockquote>
Returns the Pd library dir (as determined at compile time). This is useful
if your Pure scripts need to access files in that directory.</blockquote>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">char</span> <span class="pre">*pd_path_sl();</span></tt></p>
<blockquote>
Returns the Pd path (set in the File/Path dialog or via the <tt class="docutils literal"><span class="pre">-path</span></tt>
command line option) as a list of directory names. This is useful if your
Pure scripts need to locate files on the Pd search path.</blockquote>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">void</span> <span class="pre">pd_post(char</span> <span class="pre">*s);</span></tt></p>
<blockquote>
Posts a message in the Pd main window. A trailing newline is added
automatically. This provides an alternative interface to Pd's <tt class="docutils literal"><span class="pre">post()</span></tt>
function which cannot be used in Pure because it is a <tt class="docutils literal"><span class="pre">printf</span></tt>-style
routine expecting a variable number of arguments.</blockquote>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">double</span> <span class="pre">pd_time();</span></tt></p>
<blockquote>
Retrieves the current Pd time as a double value in milliseconds, which is
useful, in particular, when used in conjunction with the asynchronous
message facility described under <a class="reference internal" href="#asynchronous-messages">Asynchronous Messages</a>.</blockquote>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">expr*</span> <span class="pre">pd_getbuffer(char</span> <span class="pre">*name);</span></tt></p>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">void</span> <span class="pre">pd_setbuffer(char</span> <span class="pre">*name,</span> <span class="pre">expr*</span> <span class="pre">x);</span></tt></p>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">int</span> <span class="pre">pd_getbuffersize(char</span> <span class="pre">*name);</span></tt></p>
<p><tt class="docutils literal"><span class="pre">extern</span> <span class="pre">void</span> <span class="pre">pd_setbuffersize(char</span> <span class="pre">*name,</span> <span class="pre">uint32_t</span> <span class="pre">sz);</span></tt></p>
<blockquote>
<p>Routines to access the Pd array (sample buffer) with the given name. These
functions can be used to transfer audio data between Pd and Pure scripts;
see <a class="reference internal" href="#reading-and-writing-audio-data">Reading and Writing Audio Data</a> above for an example.</p>
<p><tt class="docutils literal"><span class="pre">pd_getbuffersize</span></tt> and <tt class="docutils literal"><span class="pre">pd_setbuffersize</span></tt> gets or sets the size of the
given buffer, respectively.</p>
<p><tt class="docutils literal"><span class="pre">pd_getbuffer</span></tt> reads the contents of the buffer and returns it as a Pure
vector (or fails if the array with the given name doesn't exist).</p>
<p><tt class="docutils literal"><span class="pre">pd_setbuffer</span></tt> sets the contents of the buffer from the given Pure vector
<tt class="docutils literal"><span class="pre">x</span></tt>. If the size of the vector exceeds the size of the buffer, the former
is truncated. Conversely, if the size of the buffer exceeds the size of the
Pure vector, the trailing samples are unaffected. <strong>NOTE:</strong> The second
argument of <tt class="docutils literal"><span class="pre">pd_setbuffer</span></tt> can also be a pair <tt class="docutils literal"><span class="pre">(i,x)</span></tt> denoting an offset
<tt class="docutils literal"><span class="pre">i</span></tt> into the array at which the sample data is to be written, so that this
routine allows you to overwrite any part of the array.</p>
</blockquote>
</div>
<div class="section" id="interactive-facilities">
<h1><a class="toc-backref" href="#id13">5&nbsp;&nbsp;&nbsp;Interactive Facilities</a></h1>
<div class="section" id="livecoding-support">
<h2><a class="toc-backref" href="#id14">5.1&nbsp;&nbsp;&nbsp;Livecoding Support</a></h2>
<p>Livecoding means that you can quickly reload your Pure scripts after changes
while the Pd patch keeps running. The Pure loader provides some experimental
support for this by means of the special <tt class="docutils literal"><span class="pre">pure-runtime</span></tt> object.</p>
<p>Sending a <tt class="docutils literal"><span class="pre">bang</span></tt> to this object tells the plugin to reload all loaded
scripts and update the Pure objects in your patch accordingly. The object also
provides two outlets to deal with the inevitable latencies caused by the
compilation process. The right outlet is banged when the compilation starts
and the left outlet gets a bang when the compilation is finished, so that a
patch using this facility can respond to these events in the appropriate way
(e.g., disabling output during compilation).</p>
<p>Note that there can be any number of <tt class="docutils literal"><span class="pre">pure-runtime</span></tt> objects in a patch,
which will all refer to the same instance of the Pure interpreter.</p>
<p>Also please note that the number of inlets and outlets of Pure objects never
changes after reloading scripts. (Pd does not support this through its API
right now.) Thus by editing and reloading the Pure scripts you can change the
functionality of existing Pure objects in a running patch, but not their
interfaces.</p>
</div>
<div class="section" id="remote-control">
<h2><a class="toc-backref" href="#id15">5.2&nbsp;&nbsp;&nbsp;Remote Control</a></h2>
<p>The distribution also includes an abstraction pure-remote.pd which you can
include in your patch to enable live coding, as well as remote control of the
patch through the pdsend program. Sending a <tt class="docutils literal"><span class="pre">bang</span></tt> causes a reload of all
scripts, which can also be triggered directly by clicking the bang control of
the abstraction. The bang control also provides visual feedback indicating
whether the compilation is still in progress. Messages are also routed through
the embedded <tt class="docutils literal"><span class="pre">pure-runtime</span></tt> object using the single inlet and the two
outlets of the abstraction, so that <tt class="docutils literal"><span class="pre">pure-remote</span></tt> can also be controlled
from within the patch itself.</p>
<p>For added convenience, the <tt class="docutils literal"><span class="pre">pure-runtime</span></tt> and <tt class="docutils literal"><span class="pre">pure-remote</span></tt> objects also
accept any other message of the form <tt class="docutils literal"><span class="pre">receiver</span> <span class="pre">message</span></tt> and will route the
given message to the given receiver. This is intended to provide remote
control of various parameters in patches. For instance, by having pdsend send
a <tt class="docutils literal"><span class="pre">play</span> <span class="pre">0</span></tt> or <tt class="docutils literal"><span class="pre">play</span> <span class="pre">1</span></tt> message, one might implement a single playback
control, provided that your patch includes an appropriate receiver (often a
GUI object). See the pure-help.pd patch for an example.</p>
<p>To make these features available in Emacs, there's an accompanying elisp
program (pure-remote.el) which contains some convenient keybindings for the
necessary pdsend invocations, so that you can operate the pure-remote patch
with simple keystrokes directly from the text editor. Please see the
pure-remote.el file for more details. Currently pure-remote.el implements the
following &quot;standard&quot; keybindings:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="10%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-X</span></tt></td>
<td>Reload</td>
<td>Sends a bang message, causing scripts to be reloaded.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-M</span></tt></td>
<td>Message</td>
<td>Prompts for a message and sends it to pure-remote.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-S</span></tt></td>
<td>Play</td>
<td>Sends a <tt class="docutils literal"><span class="pre">play</span> <span class="pre">1</span></tt> message.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-T</span></tt></td>
<td>Stop</td>
<td>Sends a <tt class="docutils literal"><span class="pre">play</span> <span class="pre">0</span></tt> message.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-G</span></tt></td>
<td>Restart</td>
<td>Sends a <tt class="docutils literal"><span class="pre">play</span> <span class="pre">0</span></tt> message followed by <tt class="docutils literal"><span class="pre">play</span> <span class="pre">1</span></tt>.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-I</span></tt></td>
<td>Dsp On</td>
<td>Sends a <tt class="docutils literal"><span class="pre">pd</span> <span class="pre">dsp</span> <span class="pre">1</span></tt>, which enables audio processing.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">C-C</span> <span class="pre">C-O</span></tt></td>
<td>Dsp Off</td>
<td>Sends <tt class="docutils literal"><span class="pre">pd</span> <span class="pre">dsp</span> <span class="pre">0</span></tt>, which disables audio processing.</td>
</tr>
</tbody>
</table>
<p>Of course you can easily add more like these, just have a look at how the
keybindings are implemented in pure-remote.el and create your own in an
analogous fashion. Combining pure-remote.el with the Emacs Pure programming
mode gives you a nice interactive environment for developing pd-pure
applications.</p>
<!-- Enjoy. :) -->
<!-- Albert Graef <Dr.Graef@t-online.de> -->
</div>
</div>
</div>
</body>
</html>
